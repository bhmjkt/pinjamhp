<!DOCTYPE html>
<html>
<head>
    <title>Log & Status HP Sekolah (Final Offline)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, select, button { padding: 8px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; }
        .form-section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        
        /* Warna Tombol */
        .btn-pagi { background-color: #f44336; color: white; border: none; } 
        .btn-pinjam { background-color: #4CAF50; color: white; border: none; }
        .btn-kembali { background-color: #008CBA; color: white; border: none; }
        
        /* Gaya Status Inventaris */
        #status_inventaris { margin-top: 30px; }
        #status_inventaris th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <h2>üìù Log & Status HP Sekolah</h2>
    
    <h3>üìä Status HP Terkini (Real-Time)</h3>
    <table id="status_inventaris">
        <thead>
            <tr>
                <th>Kelas</th>
                <th>HP Awal (Pagi)</th>
                <th>HP Keluar (Dipinjam)</th>
                <th>HP Sisa di Piket</th>
                <th>Keterangan</th>
            </tr>
        </thead>
        <tbody id="status_body">
            </tbody>
    </table>
    
    <hr>
    
    <div class="form-section">
        <h3>1. PENGUMPULAN PAGI (Awal Hari)</h3>
        <p>Aksi ini akan **menimpa data HP Awal** kelas ini jika sudah ada.</p>
        <select id="pagi_kelas" required>
            <option value="">Pilih Kelas...</option>
            <option value="X FAR">X FAR</option>
            <option value="X KP 1">X KP 1</option>
            <option value="X KP 2">X KP 2</option>
            <option value="X KP 3">X KP 3</option>
            <option value="XI FAR 1">XI FAR 1</option>
            <option value="XI FAR 2">XI FAR 2</option>
            <option value="XI KP 1">XI KP 1</option>
            <option value="XI KP 2">XI KP 2</option>
            <option value="XI KP 3">XI KP 3</option>
            <option value="XII FAR 1">XII FAR 1</option>
            <option value="XII FAR 2">XII FAR 2</option>
            <option value="XII KP 1">XII KP 1</option>
            <option value="XII KP 2">XII KP 2</option>
        </select>
        <input type="text" id="pagi_pj" placeholder="Nama PJ yang Mengumpulkan" required>
        <input type="number" id="pagi_jumlah" placeholder="Jumlah HP Dikumpulkan" required>
        <button class="btn-pagi" onclick="catatPengumpulanPagi()">Catat Pengumpulan Sekarang</button>
    </div>
    
    <div class="form-section">
        <h3>2. PINJAM (HP KELUAR)</h3>
        <input type="text" id="pinjam_pj" placeholder="Nama PJ/Peminjam" required>
        <select id="pinjam_kelas" required>
            <option value="">Pilih Kelas...</option>
            <option value="X FAR">X FAR</option>
            <option value="X KP 1">X KP 1</option>
            <option value="X KP 2">X KP 2</option>
            <option value="X KP 3">X KP 3</option>
            <option value="XI FAR 1">XI FAR 1</option>
            <option value="XI FAR 2">XI FAR 2</option>
            <option value="XI KP 1">XI KP 1</option>
            <option value="XI KP 2">XI KP 2</option>
            <option value="XI KP 3">XI KP 3</option>
            <option value="XII FAR 1">XII FAR 1</option>
            <option value="XII FAR 2">XII FAR 2</option>
            <option value="XII KP 1">XII KP 1</option>
            <option value="XII KP 2">XII KP 2</option>
        </select>
        <input type="number" id="pinjam_jumlah" placeholder="Jumlah HP Dipinjam" required>
        <input type="text" id="pinjam_guru" placeholder="Guru Mata Pelajaran" required>
        <button class="btn-pinjam" onclick="catatPeminjaman()">Catat Peminjaman Sekarang</button>
    </div>

    <div class="form-section">
        <h3>3. KEMBALI (HP MASUK)</h3>
        <input type="text" id="kembali_pj" placeholder="Nama PJ/Pengembali" required>
        <select id="kembali_kelas" required>
            <option value="">Pilih Kelas...</option>
            <option value="X FAR">X FAR</option>
            <option value="X KP 1">X KP 1</option>
            <option value="X KP 2">X KP 2</option>
            <option value="X KP 3">X KP 3</option>
            <option value="XI FAR 1">XI FAR 1</option>
            <option value="XI FAR 2">XI FAR 2</option>
            <option value="XI KP 1">XI KP 1</option>
            <option value="XI KP 2">XI KP 2</option>
            <option value="XI KP 3">XI KP 3</option>
            <option value="XII FAR 1">XII FAR 1</option>
            <option value="XII FAR 2">XII FAR 2</option>
            <option value="XII KP 1">XII KP 1</option>
            <option value="XII KP 2">XII KP 2</option>
        </select>
        <input type="number" id="kembali_jumlah" placeholder="Jumlah HP Dikembalikan" required>
        <button class="btn-kembali" onclick="catatPengembalian()">Catat Pengembalian Sekarang</button>
    </div>

    <hr>
    
    <div class="form-section" style="background-color: #fff8e1;">
        <h3>‚öôÔ∏è PENGATURAN DATA & LAPORAN</h3>
        <p>Gunakan fungsi ini untuk Cadangan Data atau Reset Total.</p>

        <button style="background-color: #008CBA; color: white; margin-bottom: 5px;" onclick="exportLogToCSV()">EXPORT RIWAYAT LOG (.csv) - CADANGAN</button>
        <button style="background-color: #d32f2f; color: white;" onclick="hapusSemuaData()">HAPUS SEMUA RIWAYAT LOG & STATUS (RESET TOTAL)</button>
        
        <p style="font-size: 0.8em; color: #757575;">‚ö†Ô∏è **Peringatan:** Riwayat Log dan Status tersimpan di perangkat ini. **Wajib** Cadangkan sebelum Reset Total!</p>
    </div>
    <hr>

    <h3>Riwayat Log (Aksi yang Sudah Dilakukan)</h3>
    <table>
        <thead>
            <tr>
                <th>Aksi</th>
                <th>Waktu & Tanggal</th>
                <th>PJ/Peminjam</th>
                <th>Kelas</th>
                <th>Jumlah HP</th>
                <th>Guru Mapel</th>
            </tr>
        </thead>
        <tbody id="log_body">
            </tbody>
    </table>

    <script>
        const LOG_KEY = 'hp_log_data';
        const DAFTAR_KELAS = [
            "X FAR", "X KP 1", "X KP 2", "X KP 3",
            "XI FAR 1", "XI FAR 2", "XI KP 1", "XI KP 2", "XI KP 3",
            "XII FAR 1", "XII FAR 2", "XII KP 1", "XII KP 2"
        ];

        // --- FUNGSI DASAR ---
        function muatLog() {
            const data = localStorage.getItem(LOG_KEY);
            return data ? JSON.parse(data) : [];
        }

        function simpanLog(logData) {
            localStorage.setItem(LOG_KEY, JSON.stringify(logData));
        }
        
        // --- FUNGSI EKSPOR DATA KE CSV ---
        function exportLogToCSV() {
            const logData = muatLog();
            if (logData.length === 0) {
                alert("Tidak ada data log untuk diekspor.");
                return;
            }

            // 1. Tentukan Header Kolom
            const headers = ["Aksi", "Waktu", "Tanggal", "PJ_Peminjam", "Kelas", "Jumlah_HP", "Guru_Mapel"];

            // 2. Petakan data ke array baris (array of arrays)
            const rows = logData.map(item => [
                item.aksi,
                new Date(item.waktu).toLocaleTimeString('id-ID'),
                new Date(item.waktu).toLocaleDateString('id-ID'),
                item.pj || '', 
                item.kelas,
                item.jumlah,
                item.guru || '-'
            ]);

            // 3. Gabungkan Header dan Baris
            let csvContent = headers.join(";") + "\n" + rows.map(e => e.join(";")).join("\n");

            // 4. Buat BLOB dan Unduh
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);

            link.setAttribute("href", url);
            link.setAttribute("download", `log_hp_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Data log berhasil diekspor ke file CSV!");
        }

        // --- FUNGSI HAPUS SEMUA DATA (RESET TOTAL) ---
        function hapusSemuaData() {
            if (confirm("ANDA YAKIN INGIN MENGHAPUS SEMUA RIWAYAT LOG DAN STATUS INVENTARIS? Pastikan Anda sudah mencadangkan data!")) {
                localStorage.removeItem(LOG_KEY);
                alert("Semua data log berhasil dihapus. Halaman akan dimuat ulang untuk memulai sesi baru.");
                location.reload(); 
            }
        }
        // --- AKHIR FUNGSI HAPUS ---


        // --- FUNGSI STATUS INVENTARIS ---
        function perbaruiStatusInventaris() {
            const logData = muatLog();
            const statusBody = document.getElementById('status_body');
            statusBody.innerHTML = '';
            
            const statusKelas = {}; 

            logData.forEach(item => {
                const kelas = item.kelas;
                if (!statusKelas[kelas]) {
                    statusKelas[kelas] = { awal: 0, keluar: 0, sisa: 0 };
                }
                const jumlah = parseInt(item.jumlah);

                if (item.aksi === 'PENGUMPULAN PAGI') {
                    statusKelas[kelas].awal = jumlah;
                } else if (item.aksi === 'PINJAM (KELUAR)') {
                    statusKelas[kelas].keluar += jumlah;
                } else if (item.aksi === 'KEMBALI (MASUK)') {
                    statusKelas[kelas].keluar -= jumlah;
                }
            });

            DAFTAR_KELAS.forEach(kelas => {
                const status = statusKelas[kelas] || { awal: 0, keluar: 0, sisa: 0 };
                status.sisa = status.awal - status.keluar;

                const row = statusBody.insertRow();
                row.insertCell().textContent = kelas;
                row.insertCell().textContent = status.awal;
                
                const cellKeluar = row.insertCell();
                cellKeluar.textContent = status.keluar < 0 ? 'Error!' : status.keluar;
                cellKeluar.style.backgroundColor = status.keluar > 0 ? '#ffdddd' : '#ddffdd'; 

                row.insertCell().textContent = status.sisa;
                
                let keterangan = '';
                if (status.awal === 0) {
                    keterangan = 'Belum ada pengumpulan pagi.';
                } else if (status.sisa < 0 || status.keluar < 0) {
                    keterangan = 'ERROR: Jumlah HP tidak konsisten!';
                    row.style.backgroundColor = '#ff4444'; 
                } else if (status.keluar > 0) {
                    keterangan = 'SEDANG DIPINJAM UNTUK MAPEL.';
                } else {
                    keterangan = 'HP Tersimpan di Piket.';
                }
                row.insertCell().textContent = keterangan;
            });
        }

        // --- FUNGSI UTAMA (tampilkanLog) ---
        function tampilkanLog() {
            const logData = muatLog();
            const logBody = document.getElementById('log_body');
            logBody.innerHTML = ''; 
            
            logData.sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

            logData.forEach(item => {
                const row = logBody.insertRow();
                row.insertCell().textContent = item.aksi;
                row.insertCell().textContent = new Date(item.waktu).toLocaleString('id-ID'); 
                row.insertCell().textContent = item.pj || '-';
                row.insertCell().textContent = item.kelas;
                row.insertCell().textContent = item.jumlah;
                row.insertCell().textContent = item.guru || '-';
            });
            
            perbaruiStatusInventaris();
        }

        // --- FUNGSI PENGUMPULAN PAGI (TIDAK ADA RESET OTOMATIS) ---
        function catatPengumpulanPagi() {
            const kelas = document.getElementById('pagi_kelas').value; 
            const pj = document.getElementById('pagi_pj').value;
            const jumlah = document.getElementById('pagi_jumlah').value;

            if (!kelas || !pj || !jumlah) {
                alert('Pilih Kelas, isi Nama PJ, dan isi Jumlah HP pada Pengumpulan Pagi!');
                return;
            }
            
            const logData = muatLog();
            
            // Logika Penimpaan (Keep Pinjam/Kembali): 
            // Filter logData untuk MENGHAPUS HANYA log 'PENGUMPULAN PAGI' yang lama untuk kelas ini.
            let newLogData = logData.filter(item => !(item.aksi === 'PENGUMPULAN PAGI' && item.kelas === kelas));
            
            // Tambahkan log Pengumpulan Pagi yang baru (menimpa yang lama)
            newLogData.unshift({
                aksi: 'PENGUMPULAN PAGI',
                waktu: new Date().toISOString(),
                pj: pj, 
                kelas: kelas,
                jumlah: jumlah,
                guru: '' 
            });

            simpanLog(newLogData);
            tampilkanLog();
            document.getElementById('pagi_kelas').value = ''; 
            document.getElementById('pagi_pj').value = ''; 
            document.getElementById('pagi_jumlah').value = '';
        }

        // --- FUNGSI PINJAM (VALIDASI SISA HP) ---
        function catatPeminjaman() {
            const pj = document.getElementById('pinjam_pj').value;
            const kelas = document.getElementById('pinjam_kelas').value;
            const jumlah = document.getElementById('pinjam_jumlah').value;
            const guru = document.getElementById('pinjam_guru').value;

            if (!pj || !kelas || !jumlah || !guru) {
                alert('Semua kolom Peminjaman harus diisi!');
                return;
            }
            
            const logData = muatLog();
            let statusKelas = { [kelas]: { awal: 0, keluar: 0 } }; 
            logData.forEach(item => {
                if (item.kelas === kelas) {
                    const jml = parseInt(item.jumlah);
                    if (item.aksi === 'PENGUMPULAN PAGI') { statusKelas[kelas].awal = jml; }
                    else if (item.aksi === 'PINJAM (KELUAR)') { statusKelas[kelas].keluar += jml; } 
                    else if (item.aksi === 'KEMBALI (MASUK)') { statusKelas[kelas].keluar -= jml; } 
                }
            });

            const sisaHP = (statusKelas[kelas].awal || 0) - (statusKelas[kelas].keluar || 0);
            
            if (sisaHP < parseInt(jumlah)) {
                alert(`HP kelas ${kelas} yang tersisa di piket hanya ${sisaHP}. Tidak cukup untuk meminjam ${jumlah} unit. Transaksi dibatalkan!`);
                return;
            }

            logData.unshift({ 
                aksi: 'PINJAM (KELUAR)',
                waktu: new Date().toISOString(),
                pj: pj,
                kelas: kelas,
                jumlah: jumlah,
                guru: guru
            });

            simpanLog(logData);
            tampilkanLog();
            document.getElementById('pinjam_pj').value = '';
            document.getElementById('pinjam_jumlah').value = '';
            document.getElementById('pinjam_guru').value = '';
        }

        // --- FUNGSI PENGEMBALIAN ---
        function catatPengembalian() {
            const pj = document.getElementById('kembali_pj').value;
            const kelas = document.getElementById('kembali_kelas').value;
            const jumlah = document.getElementById('kembali_jumlah').value;

            if (!pj || !kelas || !jumlah) {
                alert('Semua kolom Pengembalian harus diisi!');
                return;
            }

            const logData = muatLog();
            logData.unshift({
                aksi: 'KEMBALI (MASUK)',
                waktu: new Date().toISOString(),
                pj: pj,
                kelas: kelas,
                jumlah: jumlah,
                guru: '' 
            });

            simpanLog(logData);
            tampilkanLog();
            document.getElementById('kembali_pj').value = '';
            document.getElementById('kembali_jumlah').value = '';
        }

        // Jalankan fungsi tampilkanLog saat halaman dimuat
        window.onload = tampilkanLog;
    </script>

</body>
</html>
